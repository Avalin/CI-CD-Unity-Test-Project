name: 🧮 Resolve Deploy Matrix

on:
  workflow_call:
    inputs:
      validTargets:
        type: string
        required: true
    outputs:
      matrix:
        value: ${{ jobs.resolve.outputs.matrix }}
      requiresCombinedArtifact:
        value: ${{ jobs.resolve.outputs.requiresCombinedArtifact }}
      requiredPlatforms:
        value: ${{ jobs.resolve.outputs.requiredPlatforms }}

jobs:
  resolve:
    name: Resolve Deploy Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
      requiresCombinedArtifact: ${{ steps.set.outputs.requiresCombinedArtifact }}
      requiredPlatforms: ${{ steps.set.outputs.requiredPlatforms }}

    steps:
      - name: 📁 Checkout repo
        uses: actions/checkout@v4

      - id: set
        run: |
          DEPLOY_TARGETS='${{ inputs.validTargets }}'
          CONFIG_FILE=".github/config/deploy-targets.json"
          FALLBACK_URL="https://raw.githubusercontent.com/avalin/unity-ci-templates/main/.github/config/deploy-targets.json"

          echo "🔍 Checking for local config file..."
          if [ -f "$CONFIG_FILE" ]; then
            echo "✅ Found local config file: $CONFIG_FILE"
          else
            echo "⚠️ Not found. Downloading from: $FALLBACK_URL"
            mkdir -p "$(dirname "$CONFIG_FILE")"
            curl -sSL "$FALLBACK_URL" -o "$CONFIG_FILE"
          fi

          MATRIX='['
          COMBINED_NEEDED=false
          PLATFORM_SET=()

          # Helper: check if element is in array
          contains() { local e match="$1"; shift; for e; do [[ "$e" == "$match" ]] && return 0; done; return 1; }

          for TARGET in $(echo "$DEPLOY_TARGETS" | jq -r '.[]'); do
            OS=$(jq -r --arg t "$TARGET" '.[$t].os // "ubuntu-latest"' "$CONFIG_FILE")
            COMBINED=$(jq -r --arg t "$TARGET" '.[$t].requiresCombinedArtifact // false' "$CONFIG_FILE")
            PLATFORMS=$(jq -r --arg t "$TARGET" '.[$t].compatiblePlatforms[]?' "$CONFIG_FILE")

            MATRIX+='{"target":"'"$TARGET"'","os":"'"$OS"'","requiresCombinedArtifact":"'"$COMBINED"'"},'

            # Check if combined artifact is needed
            if [ "$COMBINED" = "true" ]; then
              COMBINED_NEEDED=true
            fi

            # Aggregate unique platforms
            for p in $PLATFORMS; do
              if ! contains "$p" "${PLATFORM_SET[@]}"; then
                PLATFORM_SET+=("$p")
              fi
            done
          done

          MATRIX="${MATRIX%,}]"

          # Convert PLATFORM_SET array to JSON
          if [ "${#PLATFORM_SET[@]}" -eq 0 ]; then
            REQUIRED_PLATFORMS='[]'
          else
            REQUIRED_PLATFORMS=$(printf '%s\n' "${PLATFORM_SET[@]}" | jq -R . | jq -s .)
          fi

          # Compact JSON (no newlines) for GitHub output
          REQUIRED_PLATFORMS_COMPACT=$(echo "$REQUIRED_PLATFORMS" | jq -c .)

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "requiresCombinedArtifact=$COMBINED_NEEDED" >> $GITHUB_OUTPUT
          echo "requiredPlatforms=$REQUIRED_PLATFORMS_COMPACT" >> $GITHUB_OUTPUT

          echo "✅ Resolved matrix: $MATRIX"
          echo "✅ Requires combined artifact: $COMBINED_NEEDED"
          echo "✅ Required platforms: $REQUIRED_PLATFORMS_COMPACT"