name: 🧮 Validate & Filter Platforms

on:
  workflow_call:
    inputs:
      targetPlatforms:
        description: "JSON array of platforms to validate and group by required OS"
        required: true
        type: string
    outputs:
      validTargetPlatforms:
        description: "Map of OS runner label to list of platforms"
        value: ${{ jobs.filter_platforms.outputs.validTargetPlatforms }}

jobs:
  filter_platforms:
    name: 🧮 Filter Platforms
    runs-on: ubuntu-latest
    outputs:
      validTargetPlatforms: ${{ steps.group.outputs.validTargetPlatforms }}

    steps:
      - name: 📁 Checkout repo
        uses: actions/checkout@v4

      - name: 🔍 Validate Platforms and Load Config
        id: validate
        run: |
          INPUT_JSON='${{ inputs.targetPlatforms }}'
          CONFIG_FILE=".github/config/target-platforms.json"
          FALLBACK_URL="https://raw.githubusercontent.com/avalin/unity-ci-templates/main/.github/config/target-platforms.json"

          echo "🔍 Validating input platforms: $INPUT_JSON"

          if [ -f "$CONFIG_FILE" ]; then
            echo "✅ Using config: $CONFIG_FILE"
          else
            echo "⚠️ Config not found. Downloading fallback..."
            mkdir -p "$(dirname "$CONFIG_FILE")"
            curl -sSL "$FALLBACK_URL" -o "$CONFIG_FILE"
          fi

          echo "$INPUT_JSON" | jq empty || {
            echo "❌ Input is not valid JSON."
            exit 1
          }

          KNOWN=$(jq -r 'keys[]' "$CONFIG_FILE")
          INPUTS=$(echo "$INPUT_JSON" | jq -r '.[]')
          VALID=()
          INVALID=()

          for PLATFORM in $INPUTS; do
            if echo "$KNOWN" | grep -qx "$PLATFORM"; then
              VALID+=("$PLATFORM")
            else
              INVALID+=("$PLATFORM")
            fi
          done

          if [ "${#INVALID[@]}" -gt 0 ]; then
            echo "⚠️ Unrecognized platforms (ignored):"
            for p in "${INVALID[@]}"; do echo "  - $p"; done
          fi

          # Export for later steps
          echo "VALID_PLATFORMS=${VALID[*]}" >> $GITHUB_ENV
          echo "INVALID_PLATFORMS=${INVALID[*]}" >> $GITHUB_ENV

          # Output valid platforms
          VALID_JSON=$(printf '%s\n' "${VALID[@]}" | jq -R . | jq -s .)
          echo "validPlatforms<<EOF" >> $GITHUB_OUTPUT
          echo "$VALID_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 🧪 Group Valid Platforms by OS
        id: group
        run: |
          CONFIG_FILE=".github/config/target-platforms.json"
          PLATFORMS='${{ steps.validate.outputs.validPlatforms }}'

          echo "📥 Grouping platforms by OS..."

          jq -n \
            --argjson platforms "$PLATFORMS" \
            --slurpfile cfg "$CONFIG_FILE" '
              $platforms
              | map({ platform: ., os: ($cfg[0][.]?.os) })
              | group_by(.os)
              | map({ (.[0].os): map(.platform) })
              | add
            ' > grouped.json

          echo "📦 Grouped platforms:"
          cat grouped.json

          echo "validTargetPlatforms<<EOF" >> $GITHUB_OUTPUT
          cat grouped.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 📋 Summary of Platform Validation
        if: always()
        run: |
          INVALID_PLATFORMS="${INVALID_PLATFORMS:-}"
          GROUPED_FILE="grouped.json"

          echo ""
          echo "📋 Target Platform Validation Summary"
          echo "──────────────────────────────────────"

          if [ -f "$GROUPED_FILE" ]; then
            echo "🧮 Grouped Platforms by OS"
            echo "────────────────────────────"

            jq -r '
              to_entries[] |
              "🖥️  \(.key):\n" +
              (.value | map("   • " + .) | join("\n"))
            ' "$GROUPED_FILE"
          else
            echo "⚠️ No grouped platform data available."
          fi

          if [ -n "$INVALID_PLATFORMS" ]; then
            echo "────────────────────────────"
            echo "⚠️ Invalid Platforms (ignored):"
            for p in $INVALID_PLATFORMS; do echo "   • $p"; done
            echo "────────────────────────────"
          fi