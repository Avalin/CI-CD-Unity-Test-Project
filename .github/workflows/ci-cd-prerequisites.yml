name: ▶️ Trigger Full Pipeline

on:
  # Allow manual dispatch with a buildType input
  workflow_dispatch:
    inputs:
      buildType:
        description: "Build type: 'preview' for manual/dev builds, 'release_candidate' for staging (e.g., v1.2.3-rc.1), 'release' for production (e.g., v1.2.3)"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - release_candidate
          - release
      version:
        description: Optional version override
        type: string
        required: false
  # Automatically run tests & builds on certain branches or PR changes
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
    paths:
      - 'Assets/**'
      - 'Packages/**'
      - 'ProjectSettings/**'
      - 'Tests/**'
  pull_request:
    types: [ready_for_review, synchronize, reopened]
    paths:
      - 'Assets/**'
      - 'Packages/**'
      - 'ProjectSettings/**'
      - 'Tests/**'

jobs:
  prepare-metadata:
    uses: ./.github/workflows/prepare-metadata.yml
    with:
      buildType: ${{ inputs.buildType }}
      version: ${{ inputs.version }}
  
  trigger-pipeline:
    needs: prepare-metadata
    uses: ./.github/workflows/ci-cd-full.yml
    with:
      buildType: ${{ needs.prepare-metadata.outputs.buildType }}
      version: ${{ needs.prepare-metadata.outputs.version }}
      validDeployTargets: ${{ needs.prepare-metadata.outputs.validDeployTargets }}
      requiresCombined: ${{ needs.prepare-metadata.outputs.requiresCombined }}
      skipPerPlatform: ${{ needs.prepare-metadata.outputs.skipPerPlatform }}
