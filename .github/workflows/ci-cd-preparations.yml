name: üèóÔ∏è CI/CD Preparations

on:
  # Allow manual dispatch with a buildType input
  workflow_dispatch:
    inputs:
      buildType:
        description: "Build type: 'preview' for manual/dev builds, 'release_candidate' for staging (e.g., v1.2.3-rc.1), 'release' for production (e.g., v1.2.3)"
        required: true
        default: "preview"
        type: choice
        options:
          - preview
          - release_candidate
          - release
      skipTests:
        description: "Whether tests should be skipped"
        required: true
        default: "false"
        type: choice
        options:
          - 'true'
          - 'false'
      deployTargets:
        description: "Deploy targets"
        required: true
        default: "[]"
        type: string
      version:
        description: Optional version override
        type: string
        required: false
  # Automatically run tests & builds on certain branches or PR changes
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
    paths:
      - 'Assets/**'
      - 'Packages/**'
      - 'ProjectSettings/**'
      - 'Tests/**'
  pull_request:
    types: [ready_for_review, synchronize, reopened]
    paths:
      - 'Assets/**'
      - 'Packages/**'
      - 'ProjectSettings/**'
      - 'Tests/**'

jobs:
  validate-vars:
    name: Validate GitHub Variables
    uses: avalin/unity-ci-templates/.github/workflows/validate-github-vars.yml@main
    with:
      requiredVars: |
        [
          "COMBINE_ARTIFACTS",
          "DEPLOY_TARGETS",
          "EXCLUDE_UNITY_TESTS",
          "PROJECT_NAME",
          "RETENTION_DAYS_PREVIEW",
          "RETENTION_DAYS_RELEASE",
          "TARGET_PLATFORMS_PREVIEW",
          "TARGET_PLATFORMS_RELEASE"
        ]

  prepare-metadata:
    name: Prepare Metadata
    needs: validate-vars
    uses: ./.github/workflows/prepare-metadata.yml
    with:
      skipTests: ${{ inputs.skipTests }}
      deployTargets: ${{ vars.DEPLOY_TARGETS }}
      buildType: ${{ inputs.buildType }}
      version: ${{ inputs.version }}
  
  trigger-ci:
    name: Trigger CI/CD Pipeline
    needs: prepare-metadata
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt-get install gh -y

      - name: Trigger downstream pipeline
        env:
          GITHUB_TOKEN: ${{ secrets.CICD_PAT }}
        run: |
          gh workflow run ci-cd-pipeline.yml \
            --ref "${{ github.ref }}" \
            --field triggeredBy="${{ needs.prepare-metadata.outputs.triggeredBy }}" \
            --field skipTests="${{ needs.prepare-metadata.outputs.skipTests }}" \
            --field buildType="${{ needs.prepare-metadata.outputs.buildType }}" \
            --field version="${{ needs.prepare-metadata.outputs.version }}" \
            --field validDeployTargets="$(printf '%s' '${{ needs.prepare-metadata.outputs.validDeployTargets }}')" \
            --field requiresCombined="${{ needs.prepare-metadata.outputs.requiresCombined }}" \
            --field skipPerPlatform="${{ needs.prepare-metadata.outputs.skipPerPlatform }}"