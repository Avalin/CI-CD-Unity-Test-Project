name: 🏷️ Build Version Generator

on:
  workflow_call:
    inputs:
      buildType:
        description: "Build type: preview | release_candidate | release"
        required: true
        type: string
      version:
        description: "Optional version override from workflow input"
        required: false
        type: string
    outputs:
      version:
        description: "The resolved build version string"
        value: ${{ jobs.determine.outputs.version }}

jobs:
  determine:
    name: 🏷️ Generate Build Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Fetch All Tags
        run: git fetch --tags --force

      - name: Determine Version
        id: get_version
        shell: bash
        run: |
          REF="${GITHUB_REF}"
          EVENT="${GITHUB_EVENT_NAME}"
          INPUT_VERSION="${{ inputs.version }}"
          BUILD_TYPE="${{ inputs.buildType }}"

          # For release builds
          if [[ "$BUILD_TYPE" == "release" ]]; then
            if [[ "$REF" =~ ^refs/tags/(v?[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              VERSION="${BASH_REMATCH[1]}"
            elif [[ -n "$INPUT_VERSION" ]]; then
              # Validate the manual version format
              if [[ "$INPUT_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                VERSION="$INPUT_VERSION"
              else
                echo "❌ Invalid manual release version: '$INPUT_VERSION'"
                echo "Must be in format: vX.Y.Z (no suffixes)"
                exit 1
              fi
            else
              echo "❌ For 'release' builds, either push a Git tag or provide a version input."
              exit 1
            fi

          # For release_candidate without manual version → auto-generate vX.Y.Z-rc.N
          elif [[ "$BUILD_TYPE" == "release_candidate" && -z "$INPUT_VERSION" ]]; then
            echo "🔍 No version provided — generating next available RC version..."

            BASE_TAG=$(git tag | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sed -E 's/^((v[0-9]+\.[0-9]+\.[0-9]+)).*/\1/' | sort -V | uniq | tail -n 1)
            BASE_TAG=${BASE_TAG:-v0.0.0}
            echo "👀 Using latest base tag: $BASE_TAG"

            chmod +x .github/scripts/build/version-generator-for-rc.sh
            VERSION=$(./.github/scripts/build/version-generator-for-rc.sh "$BASE_TAG" | tail -n 1)

          # For release_candidate with manual version → use as base
          elif [[ "$BUILD_TYPE" == "release_candidate" && -n "$INPUT_VERSION" ]]; then
            echo "🔢 Using provided version as RC base: $INPUT_VERSION"
            chmod +x .github/scripts/build/version-generator-for-rc.sh
            VERSION=$(./.github/scripts/build/version-generator-for-rc.sh "$INPUT_VERSION" | tail -n 1)

          # Manual override for non-RC builds (e.g. preview)
          elif [[ "$BUILD_TYPE" != "release" && -n "$INPUT_VERSION" ]]; then
            VERSION="$INPUT_VERSION"

          # Pull Request build
          elif [[ "$REF" =~ ^refs/pull/([0-9]+)/merge$ ]]; then
            PR_NUMBER=$(printf "%04d" "${BASH_REMATCH[1]}")
            VERSION="PR-${PR_NUMBER}"

          # Branch-based manual or CI build
          elif [[ "$REF" =~ ^refs/heads/(.+)$ ]]; then
            BRANCH_NAME=$(echo "${BASH_REMATCH[1]}" | tr '/' '-')
            if [[ "$EVENT" == "workflow_dispatch" ]]; then
              VERSION="manual-${BRANCH_NAME}"
            else
              VERSION="${BRANCH_NAME}"
            fi

          # Fallback to short commit SHA
          else
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="commit-${SHORT_SHA}"
          fi

          # If version already exists as a tag, outside of a tag-push, fail early
          if [[ ! "$GITHUB_REF" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            if git rev-parse "$VERSION" >/dev/null 2>&1; then
              echo "❌ Version '$VERSION' already exists as a tag! Aborting."
              echo "🧩 Existing tags:"
              git tag --list "${VERSION%%-*}*" || true
              exit 1
            else
              echo "✅ No existing tag conflict detected for '$VERSION'"
            fi
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "🏷️ Determined version: $VERSION"

      - name: 📋 Summarize Build Version Info
        if: always()
        run: |
          echo "### 🏷️ Build Version Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** \`${{ inputs.buildType }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** \`${{ github.event_name }}\` → \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Resolved Version:** \`${{ steps.get_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

          if [[ "${GITHUB_REF}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "- 🏷️ This was a **tag push** — tag already exists by design." >> $GITHUB_STEP_SUMMARY
          else
            if git rev-parse "${{ steps.get_version.outputs.version }}" >/dev/null 2>&1; then
              echo "- ⚠️ Tag \`${{ steps.get_version.outputs.version }}\` **already exists** — run failed on purpose to avoid overwrite." >> $GITHUB_STEP_SUMMARY
            else
              echo "- ✅ Tag \`${{ steps.get_version.outputs.version }}\` **does not exist yet** — good to go!" >> $GITHUB_STEP_SUMMARY
            fi
          fi