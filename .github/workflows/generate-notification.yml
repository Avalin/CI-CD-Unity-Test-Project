name: 🔔 Generate Notification

on:
  workflow_call:
    inputs:
      releaseResult:
        required: true
        type: string
      releaseErrorMessage:
        required: false
        type: string
      deployResult:
        required: true
        type: string
      version:
        required: true
        type: string
      testsHasFails:
        required: false
        type: string
        default: "false"
      testsTotal:
        required: false
        type: string
        default: "0"
      testsPassed:
        required: false
        type: string
        default: "0"
      testsFailedNames:
        required: false
        type: string
        default: "Skipped (tests were not run)"
    outputs:
      title:
        description: 'Main notification title'
        value: ${{ jobs.generate.outputs.title }}
      message:
        description: 'Notification body message'
        value: ${{ jobs.generate.outputs.message }}
      slackMessage:
        description: 'Slack-formatted message'
        value: ${{ jobs.generate.outputs.slackMessage }}
      discordMessage:
        description: 'Discord-formatted message'
        value: ${{ jobs.generate.outputs.discordMessage }}
      status:
        description: 'Status for use in color codes (success, failure, etc)'
        value: ${{ jobs.generate.outputs.status }}

jobs:
  generate:
    runs-on: ubuntu-latest
    outputs:
      title: ${{ steps.set-outputs.outputs.title }}
      message: ${{ steps.set-outputs.outputs.message }}
      slackMessage: ${{ steps.set-outputs.outputs.slackMessage }}
      discordMessage: ${{ steps.set-outputs.outputs.discordMessage }}
      status: ${{ steps.set-outputs.outputs.status }}
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🧱 Prepare Variables
        id: prep
        run: |
          echo "RELEASE=${{ inputs.releaseResult }}" >> $GITHUB_ENV
          echo "DEPLOY=${{ inputs.deployResult }}" >> $GITHUB_ENV
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          echo "ERROR=${{ inputs.releaseErrorMessage }}" >> $GITHUB_ENV
          echo "REPO=${{ github.repository }}" >> $GITHUB_ENV
          echo "RELEASE_URL=https://github.com/${{ github.repository }}/releases/tag/${{ inputs.version }}" >> $GITHUB_ENV
          echo "RUN_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV
          if [[ "${GITHUB_REF_TYPE}" != "tag" ]]; then
            echo "BRANCH=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          else
            echo "BRANCH=" >> $GITHUB_ENV
          fi
          echo "COMMIT=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "PR_NUMBER=${{ github.event.pull_request.number || '' }}" >> $GITHUB_ENV

      - name: 🧠 Determine Status and Message
        id: determine
        run: |
          TRACE=""
          [[ -n "$PR_NUMBER" ]] && TRACE+="PR #$(printf '%04d' "$PR_NUMBER")"
          [[ -n "$BRANCH" ]] && TRACE+="${TRACE:+ | }Branch: \`$BRANCH\`"
          [[ -n "$COMMIT" ]] && TRACE+="${TRACE:+ | }Commit: \`$(echo "$COMMIT" | cut -c1-7)\`"

          if [[ "${{ inputs.testsHasFails }}" == "true" && "${{ inputs.testsTotal }}" != "0" ]]; then
            TITLE="Tests Failed - $VERSION"
            MESSAGE="❌ Some tests failed on version \`$VERSION\`.\n"
            MESSAGE+="✅ Passed: ${{ inputs.testsPassed }} / ${{ inputs.testsTotal }}\n"

            # Set max number of failed test names to include
            MAX_FAILED_TESTS=5
            
            echo "AAAHHH: ${{ inputs.testsFailedNames }}"
            
            # Limit to first N failed tests
            FAILED_LIST=$(echo "${{ inputs.testsFailedNames }}" | head -n $MAX_FAILED_TESTS)
            TOTAL_FAILED_LINES=$(echo "${{ inputs.testsFailedNames }}" | wc -l)

            if [[ "$TOTAL_FAILED_LINES" -gt $MAX_FAILED_TESTS ]]; then
                FAILED_LIST+="\n...and $((TOTAL_FAILED_LINES - MAX_FAILED_TESTS)) more"
            fi

            MESSAGE+="❌ Failed Tests:\n$FAILED_LIST"

            STATUS="failure"
            [[ -n "$TRACE" ]] && MESSAGE="$MESSAGE\n\n$TRACE"
            MESSAGE="$MESSAGE\n\n🔗 [View Pipeline]($RUN_URL)"

          elif [[ "$RELEASE" == "success" ]]; then
            if [[ "$DEPLOY" == "success" ]]; then
              TITLE="Release & Deploy Succeeded - $VERSION"
              MESSAGE="✅ Release \`$VERSION\` completed successfully."
              STATUS="success"
            elif [[ "$DEPLOY" == "skipped" ]]; then
              TITLE="Release Succeeded (No Deploy) - $VERSION"
              MESSAGE="✅ Release \`$VERSION\` completed successfully. No deployment targets set."
              STATUS="neutral"
            else
              TITLE="Release Succeeded, Deploy Failed - $VERSION"
              MESSAGE="⚠️ Release \`$VERSION\` succeeded, but deployment failed."
              STATUS="failure"
            fi
            [[ -n "$TRACE" ]] && MESSAGE="$MESSAGE\n$TRACE"
            MESSAGE="$MESSAGE\n📦 [View Release]($RELEASE_URL)   ·   🔗 [View Pipeline]($RUN_URL)"

          else
            TITLE="Release Failed - $VERSION"
            if [[ -n "$ERROR" ]]; then
              MESSAGE="❌ Release \`$VERSION\` failed: \`$ERROR\`."
            else
              MESSAGE="❌ Release \`$VERSION\` failed."
            fi
            STATUS="failure"
            [[ -n "$TRACE" ]] && MESSAGE="$MESSAGE\n$TRACE"
            MESSAGE="$MESSAGE\n🔗 [View Pipeline]($RUN_URL)"
          fi

          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$MESSAGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 📥 Download Deploy Result Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deployment-results-*
          path: deploy-results
          merge-multiple: true

      - name: 💬 Format Final Notification Messages
        id: set-outputs
        run: |
          chmod +x .github/scripts/notify/*.sh

          SLACK_MESSAGE=$(bash .github/scripts/notify/format-slack.sh "$MESSAGE" "$RUN_URL" "$RELEASE_URL")
          DISCORD_MESSAGE=$(bash .github/scripts/notify/format-discord.sh "$MESSAGE" "$RUN_URL" "$RELEASE_URL")

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"

          echo "message<<EOF" >> "$GITHUB_OUTPUT"
          echo "$MESSAGE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "slackMessage<<EOF" >> "$GITHUB_OUTPUT"
          echo "$SLACK_MESSAGE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          echo "discordMessage<<EOF" >> "$GITHUB_OUTPUT"
          echo "$DISCORD_MESSAGE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"