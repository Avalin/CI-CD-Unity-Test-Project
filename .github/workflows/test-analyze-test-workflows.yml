name: ðŸ§ª Test Analyze & Tests Workflow

on:
  workflow_dispatch:
    inputs:
        allowAutofix:
            description: "Whether to allow autofixing lint issues on PR"
            required: false
            default: 'false'
            type: choice
            options:
              - 'true'
              - 'false'
        allowFail:
            description: "Whether lint errors should fail the pipeline"
            required: false
            default: 'true'
            type: choice
            options:
            - 'true'
            - 'false'
        shouldRunTests:
            description: "Whether tests should be ran or not"
            required: false
            default: 'true'
            type: choice
            options:
            - 'true'
            - 'false'

permissions:
  contents: write
  pull-requests: write

jobs:
  test-analyze:
    name: Analyze with Roslynator
    uses: avalin/unity-ci-templates/.github/workflows/step-0-roslyn-analyze.yml@main
    
  test-run-tests:
    name: Test Run Tests
    if: ${{ inputs.shouldRunTests == 'true' }}
    needs: [ test-analyze ]
    uses: avalin/unity-ci-templates/.github/workflows/step-1-test.yml@main
    with:
      unityVersion: ${{ vars.UNITY_VERSION }}
      licenseArtifactName: ${{ vars.LICENSE_ARTIFACT_NAME }}
      useGitLfs: ${{ vars.USE_GIT_LFS }}
      editModePath: ${{ vars.UNITY_TESTS_EDITMODE_PATH }}
      playModePath: ${{ vars.UNITY_TESTS_PLAYMODE_PATH }}
      timeoutMinutes: ${{ fromJson(vars.TIMEOUT_TESTS_IN_MINUTES) }}
    secrets:
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
